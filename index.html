<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanmati Kids School - Result Portal 2025-26</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Inter:wght@400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background: #f0f9ff; margin: 0; padding: 0; }
        .heading-font { font-family: 'Fredoka', sans-serif; }
        .result-card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .gradient-bg { background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%); }
        
        .school-logo-img {
            width: 85px;
            height: 85px;
            object-fit: contain;
            background: white;
            padding: 5px;
            border-radius: 12px;
        }

        /* Watermark Styling */
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 450px;
            opacity: 0.05;
            pointer-events: none;
            z-index: 0;
        }

        .absent-text { color: #ef4444; font-weight: bold; font-style: italic; }

        /* Print Optimization to fit in Single Page */
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            #printableArea {
                position: relative;
                width: 100%;
                padding: 0;
                margin: 0;
                box-shadow: none;
                border: none;
                overflow: hidden;
            }
            .result-card { border: none !important; }
            /* Scaling for A4 */
            #printableArea {
                transform: scale(0.98);
                transform-origin: top center;
            }
            @page {
                size: A4;
                margin: 10mm;
            }
        }

        #loadingOverlay {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-sky-800 animate-pulse uppercase tracking-widest text-xs">Fetching Details...</p>
    </div>

    <!-- Header (No Print) -->
    <header class="gradient-bg text-white py-6 px-4 shadow-lg no-print">
        <div class="max-w-4xl mx-auto flex flex-col items-center text-center">
            <div class="mb-3">
                <img src="https://schoolerpindia.co.in/school/sanmatikids/uploads/f2024062700favicon.jpeg" alt="Logo" class="school-logo-img shadow-xl">
            </div>
            <h1 class="heading-font text-3xl md:text-4xl font-bold tracking-tight uppercase">SANMATI KIDS SCHOOL</h1>
            <p class="mt-2 bg-white/20 px-4 py-1 rounded-full text-xs font-bold tracking-widest uppercase italic">Student Progress Report Portal</p>
        </div>
    </header>

    <!-- Search Section (No Print) -->
    <main class="flex-grow container mx-auto px-4 py-12 max-w-lg no-print" id="loginSection">
        <div class="result-card p-8 border-b-4 border-sky-500">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800">Check Your Result</h2>
                <p class="text-gray-500 italic">Enter Roll No. or Registration No.</p>
            </div>

            <form id="resultForm" class="space-y-6">
                <div class="relative">
                    <input type="text" id="rollNo" required placeholder="Roll No. / Registration No." 
                        class="w-full px-4 py-4 border-2 border-gray-100 rounded-xl focus:ring-2 focus:ring-sky-500 outline-none text-lg pr-12">
                    <i class="fas fa-id-card absolute right-4 top-1/2 -translate-y-1/2 text-gray-300 text-xl"></i>
                </div>

                <button type="submit" id="searchBtn" class="w-full gradient-bg text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center space-x-2 text-lg">
                    <span>View Marks & Details</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>

            <div id="errorBox" class="hidden mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 text-center">
                Student details not found.
            </div>
        </div>
    </main>

    <!-- Marksheet Result Section -->
    <section id="resultSection" class="hidden container mx-auto px-4 py-8 max-w-5xl">
        <div class="no-print mb-6 flex justify-between items-center">
            <button onclick="window.location.reload()" class="bg-white text-sky-600 border border-sky-200 px-4 py-2 rounded-lg font-semibold flex items-center">
                <i class="fas fa-chevron-left mr-2"></i> Back to Search
            </button>
            <button onclick="window.print()" class="bg-gray-800 text-white px-8 py-2.5 rounded-lg flex items-center shadow-lg font-bold hover:bg-black transition-all">
                <i class="fas fa-print mr-2"></i> Print Marksheet
            </button>
        </div>

        <div id="printableArea" class="result-card p-6 md:p-10 border-t-8 border-sky-500 relative bg-white overflow-hidden">
            <!-- Background Watermark -->
            <img src="https://schoolerpindia.co.in/school/sanmatikids/uploads/f2024062700favicon.jpeg" class="watermark" alt="Watermark">

            <!-- School Header -->
            <div class="flex flex-col md:flex-row justify-between items-start border-b-2 border-gray-100 pb-6 relative z-10">
                <div class="flex items-center space-x-4">
                    <img src="https://schoolerpindia.co.in/school/sanmatikids/uploads/f2024062700favicon.jpeg" alt="Logo" class="school-logo-img">
                    <div class="text-left">
                        <h2 class="heading-font text-2xl md:text-3xl font-bold text-sky-600 uppercase">SANMATI KIDS SCHOOL</h2>
                        <p class="text-[9px] text-sky-500 font-bold uppercase mt-1">Reg ID: <span id="verNoHeader" class="text-gray-900">---</span></p>
                    </div>
                </div>
                <div class="text-center md:text-right mt-4 md:mt-0">
                    <h3 class="font-bold text-xl text-gray-800 uppercase">Half-Yearly Examination</h3>
                    <p class="text-xs font-bold text-gray-500">SESSION 2025-26</p>
                </div>
            </div>

            <!-- Student Profile Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-8 relative z-10 text-sm">
                <div class="bg-gray-50 p-4 rounded-xl space-y-2 border border-gray-100">
                    <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold text-[10px]">Student Name:</span> <span id="dispName" class="font-bold uppercase"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold text-[10px]">Father's Name:</span> <span id="dispFather" class="font-bold uppercase"></span></div>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl space-y-2 border border-gray-100">
                    <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold text-[10px]">Enrollment No:</span> <span id="dispEnroll" class="font-bold"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold text-[10px]">Roll Number:</span> <span id="dispRoll" class="font-bold"></span></div>
                </div>
            </div>

            <!-- Marks Table -->
            <div class="relative z-10 mb-8 border border-gray-200 rounded-xl overflow-hidden">
                <table class="w-full text-center">
                    <thead class="bg-sky-600 text-white text-[10px] uppercase">
                        <tr>
                            <th class="py-3 px-4 text-left">Subject Name</th>
                            <th class="py-3">Theory (75)</th>
                            <th class="py-3">Internal (25)</th>
                            <th class="py-3">Total (100)</th>
                            <th class="py-3">Grade</th>
                        </tr>
                    </thead>
                    <tbody id="marksTable" class="text-sm font-medium">
                        <!-- Content injected by JavaScript -->
                    </tbody>
                    <tfoot class="bg-gray-800 text-white font-bold">
                        <tr>
                            <td class="py-3 px-4 text-left uppercase text-[10px]">Total Obtained</td>
                            <td colspan="2" class="text-[10px] opacity-60">MAX MARKS: 600</td>
                            <td id="totalObtained" class="py-3 text-lg">---</td>
                            <td id="finalGrade" class="py-3 text-yellow-400 text-lg">---</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Dashboard Analytics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8 relative z-10 text-center">
                <div class="p-3 border rounded-xl bg-white shadow-sm">
                    <p class="text-[8px] text-gray-400 uppercase font-bold">Percentage</p>
                    <p id="percentage" class="text-xl font-bold text-sky-600">0%</p>
                </div>
                <div class="p-3 border rounded-xl bg-white shadow-sm">
                    <p class="text-[8px] text-gray-400 uppercase font-bold">Class Rank</p>
                    <p id="acrRank" class="text-xl font-bold">#--</p>
                </div>
                <div class="p-3 border rounded-xl bg-white shadow-sm">
                    <p class="text-[8px] text-gray-400 uppercase font-bold">School Rank</p>
                    <p id="asrRank" class="text-xl font-bold text-purple-600">#--</p>
                </div>
                <div class="p-3 border rounded-xl bg-white shadow-sm">
                    <p class="text-[8px] text-gray-400 uppercase font-bold">Status</p>
                    <p id="resStatus" class="text-xl font-bold text-green-600">---</p>
                </div>
            </div>

            <!-- Remarks -->
            <div class="p-4 bg-yellow-50/50 border-l-4 border-yellow-300 rounded-r-xl mb-12 relative z-10">
                <p class="text-[8px] text-gray-400 uppercase font-bold mb-1">Teacher's Remarks</p>
                <p id="remarks" class="italic text-sm text-gray-700">---</p>
            </div>

            <!-- QR & Footer Signatures -->
            <div class="flex justify-between items-end px-4 relative z-10 mt-16 pb-4">
                <div class="text-center">
                    <img src="" id="qrImage" class="w-20 h-20 mb-1 border-2 border-sky-50 p-1 bg-white" alt="Verification QR">
                    <p class="text-[7px] text-gray-400 font-bold uppercase tracking-widest">Digital Verification</p>
                </div>
                <div class="flex space-x-12">
                    <div class="text-center w-28 border-t border-gray-300 pt-1">
                        <p class="text-[9px] font-bold uppercase text-gray-400">Class Teacher</p>
                    </div>
                    <div class="text-center w-28 border-t border-gray-300 pt-1">
                        <p class="text-[9px] font-bold uppercase text-gray-400">Principal</p>
                    </div>
                </div>
            </div>

            <!-- Computer Generated Note -->
            <div class="absolute bottom-2 left-0 w-full text-center text-[8px] text-gray-300 uppercase tracking-widest">
                This is a computer generated progress report.
            </div>
        </div>
    </section>

    <footer class="mt-auto py-6 text-center text-gray-400 text-[10px] no-print uppercase tracking-widest">
        &copy; 2025-26 Sanmati Kids School Portal
    </footer>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxw4zTmbAaqTloRTf2uy_l9WAkRJJPMXthuglZ1M0bNH6m2NvPgP4ZLFOEd95NKDAI/exec";
        
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('id');
            if (studentId) {
                handleSearch(studentId);
            }
        };

        document.getElementById('resultForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const val = document.getElementById('rollNo').value.trim();
            handleSearch(val);
        });

        async function handleSearch(val) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('hidden');
            
            try {
                const res = await fetch(API_URL);
                const students = await res.json();
                
                const s = students.find(x => 
                    String(x.roll) === val || 
                    String(x.enroll) === val || 
                    String(x.verification) === val
                );
                
                if (s) {
                    const classS = students.filter(x => x.class === s.class).sort((a,b) => b.calculatedTotal - a.calculatedTotal);
                    const acr = classS.findIndex(x => x.roll === s.roll) + 1;
                    const asr = [...students].sort((a,b) => b.calculatedTotal - a.calculatedTotal).findIndex(x => x.roll === s.roll) + 1;
                    renderResult(s, acr, asr);
                } else {
                    document.getElementById('errorBox').classList.remove('hidden');
                    setTimeout(() => document.getElementById('errorBox').classList.add('hidden'), 3000);
                }
            } catch (err) { 
                console.error(err); 
            } finally {
                overlay.classList.add('hidden');
            }
        }

        function getGrade(m) {
            if (m >= 90) return "A+"; if (m >= 80) return "A";
            if (m >= 70) return "B+"; if (m >= 60) return "B";
            if (m >= 50) return "C"; return "D";
        }

        function renderResult(s, acr, asr) {
            document.getElementById('dispName').innerText = s.name;
            document.getElementById('dispFather').innerText = s.father;
            document.getElementById('dispRoll').innerText = s.roll;
            document.getElementById('dispEnroll').innerText = s.enroll;
            document.getElementById('remarks').innerText = s.remark || "Excellent progress. Keep up the hard work!";
            document.getElementById('acrRank').innerText = `#${acr}`;
            document.getElementById('asrRank').innerText = `#${asr}`;
            
            const vId = s.verification || s.enroll || s.roll;
            document.getElementById('verNoHeader').innerText = vId;

            const currentUrl = window.location.origin + window.location.pathname;
            const scanLink = `${currentUrl}?id=${vId}`;
            document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(scanLink)}`;

            const tbody = document.getElementById('marksTable');
            tbody.innerHTML = '';
            let obt = 0;

            s.subjects.forEach(sub => {
                const t = sub.theory === "AB" ? 0 : parseFloat(sub.theory) || 0;
                const n = sub.internal === "AB" ? 0 : parseFloat(sub.internal) || 0;
                const sum = t + n;
                obt += sum;
                tbody.innerHTML += `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4 text-left font-bold text-xs text-gray-700 uppercase">${sub.name}</td>
                        <td class="${sub.theory === "AB" ? "absent-text" : "text-gray-600"}">${sub.theory}</td>
                        <td class="${sub.internal === "AB" ? "absent-text" : "text-gray-600"}">${sub.internal}</td>
                        <td class="font-bold text-gray-900">${(sub.theory === "AB" && sub.internal === "AB") ? "AB" : sum}</td>
                        <td class="text-sky-600 font-bold">${getGrade(sum)}</td>
                    </tr>
                `;
            });

            const p = (obt/600)*100;
            document.getElementById('totalObtained').innerText = obt;
            document.getElementById('percentage').innerText = p.toFixed(1) + "%";
            document.getElementById('finalGrade').innerText = getGrade(p);
            document.getElementById('resStatus').innerText = p >= 33 ? "PASSED" : "PROMOTED";

            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>
